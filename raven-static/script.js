// ============================
// RAVEN - Static JavaScript Implementation
// ============================

// ============ STATE MANAGEMENT ============
const AppState = {
  currentUser: null,
  currentView: 'landing',
  houses: [],
  friends: [],
  dmMessages: {},
  houseMessages: {},
  selectedFriend: null,
  selectedHouse: null,
  
  // Initialize state from localStorage
  init() {
    const savedUser = localStorage.getItem('raven_user');
    const savedHouses = localStorage.getItem('raven_houses');
    const savedFriends = localStorage.getItem('raven_friends');
    const savedDms = localStorage.getItem('raven_dms');
    const savedHouseMsgs = localStorage.getItem('raven_house_messages');
    
    if (savedUser) {
      this.currentUser = JSON.parse(savedUser);
    }
    if (savedHouses) {
      this.houses = JSON.parse(savedHouses);
    } else {
      this.houses = this.getDefaultHouses();
      this.saveHouses();
    }
    if (savedFriends) {
      this.friends = JSON.parse(savedFriends);
    }
    if (savedDms) {
      this.dmMessages = JSON.parse(savedDms);
    }
    if (savedHouseMsgs) {
      this.houseMessages = JSON.parse(savedHouseMsgs);
    } else {
      this.initializeDefaultMessages();
    }
  },
  
  getDefaultHouses() {
    return [
      {
        id: 'h1',
        name: 'Order of Shadow',
        description: 'The silent sentinels of the digital realm.',
        emblem: 'https://picsum.photos/seed/shadow/200',
        ownerId: 'me',
        membersCount: 124,
        isPrivate: true,
        members: [
          { id: 'me', username: 'NightRaven', avatar: 'https://picsum.photos/seed/raven/200', roleId: 'r1', joinedAt: Date.now() },
          { id: 'u2', username: 'Shadow_V', avatar: 'https://picsum.photos/seed/v/200', roleId: 'r2', joinedAt: Date.now() },
        ]
      },
      {
        id: 'h2',
        name: 'Iron Vanguard',
        description: 'Elite builders and strategists.',
        emblem: 'https://picsum.photos/seed/iron/200',
        ownerId: 'u2',
        membersCount: 89,
        isPrivate: false,
        members: [
          { id: 'u2', username: 'Vanguard_Alpha', avatar: 'https://picsum.photos/seed/vanguard/50', roleId: 'r1', joinedAt: Date.now() },
          { id: 'me', username: 'NightRaven', avatar: 'https://picsum.photos/seed/raven/200', roleId: 'r4', joinedAt: Date.now() },
        ]
      },
      {
        id: 'h3',
        name: 'Lunar Syndicate',
        description: 'Trading and market intelligence collective.',
        emblem: 'https://picsum.photos/seed/lunar/200',
        ownerId: 'u3',
        membersCount: 450,
        isPrivate: false,
        members: []
      }
    ];
  },
  
  initializeDefaultMessages() {
    this.houseMessages = {
      'h1': [
        {
          id: 'm1',
          senderId: 'u2',
          senderName: 'Shadow_V',
          senderAvatar: 'https://picsum.photos/seed/v/200',
          content: 'Welcome to the inner circle.',
          timestamp: Date.now() - 3600000,
        }
      ],
      'h2': [
        {
          id: 'm2',
          senderId: 'u2',
          senderName: 'Vanguard_Alpha',
          senderAvatar: 'https://picsum.photos/seed/vanguard/50',
          content: 'Strategy meeting at 1900 hours.',
          timestamp: Date.now() - 7200000,
        }
      ]
    };
    this.saveHouseMessages();
  },
  
  saveUser() {
    localStorage.setItem('raven_user', JSON.stringify(this.currentUser));
  },
  
  saveHouses() {
    localStorage.setItem('raven_houses', JSON.stringify(this.houses));
  },
  
  saveFriends() {
    localStorage.setItem('raven_friends', JSON.stringify(this.friends));
  },
  
  saveDms() {
    localStorage.setItem('raven_dms', JSON.stringify(this.dmMessages));
  },
  
  saveHouseMessages() {
    localStorage.setItem('raven_house_messages', JSON.stringify(this.houseMessages));
  },
  
  logout() {
    this.currentUser = null;
    localStorage.removeItem('raven_user');
  }
};

// ============ SVG ICONS ============
const Icons = {
  RavenCrest: () => `
    <svg viewBox=\"0 0 200 200\" class=\"w-16 h-16\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">
      <path d=\"M100 20L115 50H85L100 20Z\" fill=\"white\" />
      <path d=\"M40 60C40 60 60 140 100 170C140 140 160 60 160 60L100 40L40 60Z\" stroke=\"white\" stroke-width=\"4\" />
      <path d=\"M50 100H150V130C150 130 130 145 100 145C70 145 50 130 50 130V100Z\" fill=\"black\" stroke=\"white\" stroke-width=\"2\" />
      <path d=\"M60 105C60 105 80 110 100 110C120 110 140 105 140 105\" stroke=\"white\" stroke-width=\"1\" stroke-dasharray=\"4 2\" />
      <path d=\"M30 50L60 80M170 50L140 80M30 150L60 120M170 150L140 120\" stroke=\"white\" stroke-width=\"3\" stroke-linecap=\"round\" />
    </svg>
  `,
  
  RavenCrestBlack: () => `
    <svg viewBox=\"0 0 200 200\" class=\"w-32 h-32 mb-8\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">
      <path d=\"M100 20L115 50H85L100 20Z\" fill=\"black\" />
      <path d=\"M40 60C40 60 60 140 100 170C140 140 160 60 160 60L100 40L40 60Z\" stroke=\"black\" stroke-width=\"4\" />
      <path d=\"M50 100H150V130C150 130 130 145 100 145C70 145 50 130 50 130V100Z\" fill=\"#eee\" stroke=\"black\" stroke-width=\"2\" />
      <path d=\"M60 105C60 105 80 110 100 110C120 110 140 105 140 105\" stroke=\"black\" stroke-width=\"1\" stroke-dasharray=\"4 2\" />
      <path d=\"M30 50L60 80M170 50L140 80M30 150L60 120M170 150L140 120\" stroke=\"black\" stroke-width=\"3\" stroke-linecap=\"round\" />
    </svg>
  `,
  
  House: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-6 h-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6\" />
    </svg>
  `,
  
  Message: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-6 h-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z\" />
    </svg>
  `,
  
  Shield: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-6 h-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />
    </svg>
  `,
  
  Profile: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-6 h-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\" />
    </svg>
  `,
  
  Plus: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-5 h-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 4v16m8-8H4\" />
    </svg>
  `,
  
  Back: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">
      <path fill-rule=\"evenodd\" d=\"M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z\" clip-rule=\"evenodd\" />
    </svg>
  `,
  
  Send: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-6 w-6 transform rotate-90\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 19l9 2-9-18-9 18 9-2zm0 0v-8\" />
    </svg>
  `,
  
  Copy: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-5 w-5 text-gray-400\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\" />
    </svg>
  `,
  
  Settings: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-5 h-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">
      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />  \n    </svg>\n  `,
  
  Delete: () => `
    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-3 w-3\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n      <path fill-rule=\"evenodd\" d=\"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z\" clip-rule=\"evenodd\" />\n    </svg>\n  `\n};\n\n// ============ VIEW RENDERING ============\nconst Views = {\n  landing: () => `\n    <div class=\"min-h-screen bg-[#050505] text-white flex flex-col items-center relative overflow-x-hidden\">\n      <!-- Top Navigation -->\n      <nav class=\"w-full max-w-7xl px-6 py-6 flex justify-between items-center z-10\">\n        <div class=\"flex items-center gap-2\">\n          <div class=\"w-8 h-8\">\n            ${Icons.RavenCrest()}\n          </div>\n          <span class=\"font-black tracking-tighter text-xl\">RAVEN</span>\n        </div>\n        <button onclick=\"navigateTo('auth')\" class=\"text-sm font-bold uppercase tracking-widest text-gray-400 hover:text-white transition-colors\">\n          Log In\n        </button>\n      </nav>\n\n      <div class=\"flex-1 flex flex-col items-center justify-center p-6 text-center space-y-12 max-w-4xl mx-auto\">\n        <div class=\"space-y-4 fade-in\">\n          <div class=\"flex justify-center mb-6\">\n            <div class=\"p-1 rounded-2xl flex items-center justify-center shadow-[0_0_40px_rgba(255,255,255,0.1)] transition-transform hover:scale-110 duration-500\">\n              ${Icons.RavenCrest()}\n            </div>\n          </div>\n          <h1 class=\"text-5xl md:text-7xl font-extrabold tracking-tighter\">\n            RAVEN\n          </h1>\n          <p class=\"text-xl md:text-2xl text-gray-400 max-w-2xl mx-auto font-light leading-relaxed\">\n            Private Communities. Secure Conversations. <br/>\n            The elite platform for structured clans and groups.\n          </p>\n        </div>\n\n        <div class=\"flex flex-col items-center gap-6 w-full max-w-md\">\n          <div class=\"flex flex-col md:flex-row gap-4 w-full\">\n            <button onclick=\"navigateTo('auth')\" class=\"flex-1 bg-white text-black px-8 py-4 rounded-xl font-bold hover:bg-gray-200 transition-all text-lg shadow-lg\">\n              Join Raven\n            </button>\n            <button onclick=\"navigateTo('auth')\" class=\"flex-1 border border-gray-700 text-white px-8 py-4 rounded-xl font-bold hover:bg-white/5 transition-all text-lg\">\n              Create a House\n            </button>\n          </div>\n          <p class=\"text-sm text-gray-500 font-medium\">\n            Already established? <button onclick=\"navigateTo('auth')\" class=\"text-white hover:underline decoration-red-900 underline-offset-4\">Log In to your House</button>\n          </p>\n        </div>\n\n        <div class=\"grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl w-full mt-24 pb-24\">\n          <div class=\"bg-[#111] border border-[#222] p-8 rounded-2xl text-left hover:border-gray-500 transition-all group\">\n            <div class=\"text-3xl mb-4 group-hover:scale-110 transition-transform inline-block\">üîí</div>\n            <h3 class=\"text-xl font-bold mb-2\">Encrypted</h3>\n            <p class=\"text-gray-500 font-light\">Your data is your own. We focus on true private networking.</p>\n          </div>\n          <div class=\"bg-[#111] border border-[#222] p-8 rounded-2xl text-left hover:border-gray-500 transition-all group\">\n            <div class=\"text-3xl mb-4 group-hover:scale-110 transition-transform inline-block\">üß†</div>\n            <h3 class=\"text-xl font-bold mb-2\">AI Moderation</h3>\n            <p class=\"text-gray-500 font-light\">Automated community safety powered by advanced LLMs.</p>\n          </div>\n          <div class=\"bg-[#111] border border-[#222] p-8 rounded-2xl text-left hover:border-gray-500 transition-all group\">\n            <div class=\"text-3xl mb-4 group-hover:scale-110 transition-transform inline-block\">üõ°Ô∏è</div>\n            <h3 class=\"text-xl font-bold mb-2\">House Structure</h3>\n            <p class=\"text-gray-500 font-light\">Advanced roles, private channels, and group collaboration.</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  `,\n  \n  auth: () => `\n    <div class=\"min-h-screen w-full bg-white relative overflow-hidden flex items-center justify-center font-sans\">\n      <!-- Crow Shadow Animation -->\n      <div class=\"absolute inset-0 pointer-events-none z-10\">\n        <div class=\"crow-shadow absolute w-[150%] h-[150%] bg-black/10 blur-3xl rounded-full -left-[150%] top-[-25%] transform -rotate-12\">\n          <div class=\"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 scale-[3]\">\n            <svg width=\"200\" height=\"100\" viewBox=\"0 0 200 100\" fill=\"black\">\n              <path d=\"M0 50C50 0 150 0 200 50C150 100 50 100 0 50Z\" opacity=\"0.4\" />\n            </svg>\n          </div>\n        </div>\n      </div>\n\n      <!-- Login Content -->\n      <div class=\"fade-in-delay flex flex-col items-center max-w-sm w-full p-8\">\n        ${Icons.RavenCrestBlack()}\n        \n        <div class=\"text-center mb-10\">\n          <h1 class=\"text-3xl font-black tracking-tighter text-black mb-2 uppercase\">Authenticate</h1>\n          <p class=\"text-gray-400 text-sm font-medium tracking-wide\">Enter the secure domain of RAVEN</p>\n        </div>\n\n        <button \n          onclick=\"handleLogin()\"\n          class=\"w-full flex items-center justify-center gap-4 bg-white border-2 border-gray-100 py-4 rounded-2xl text-black font-bold hover:bg-gray-50 hover:border-gray-200 transition-all shadow-xl shadow-gray-100/50 group\"\n        >\n          <svg class=\"w-5 h-5\" viewBox=\"0 0 24 24\">\n            <path d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\" fill=\"#4285F4\" />\n            <path d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\" fill=\"#34A853\" />\n            <path d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.26.81-.58z\" fill=\"#FBBC05\" />\n            <path d=\"M12 5.38c1.62 0 3.06.56 4.21 1.66l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\" fill=\"#EA4335\" />\n          </svg>\n          <span class=\"group-hover:tracking-wider transition-all\">Continue with Google</span>\n        </button>\n\n        <div class=\"mt-12 text-[10px] text-gray-300 font-bold uppercase tracking-[0.3em] flex items-center gap-4 w-full\">\n          <div class=\"h-[1px] flex-1 bg-gray-100\"></div>\n          Secure Transmission\n          <div class=\"h-[1px] flex-1 bg-gray-100\"></div>\n        </div>\n      </div>\n    </div>\n  `,\n  \n  dashboard: () => {\n    const houses = AppState.houses;\n    return `\n      <div class=\"flex h-screen overflow-hidden bg-[#050505]\">\n        ${renderSidebar()}\n        <main class=\"flex-1 overflow-y-auto pb-16 md:pb-0\">\n          <div class=\"p-6 md:p-12 max-w-6xl mx-auto space-y-12 pb-24\">\n            <header class=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n              <div>\n                <h1 class=\"text-4xl font-extrabold tracking-tight\">Intelligence Feed</h1>\n                <p class=\"text-gray-500\">Updates from your active sectors and houses.</p>\n              </div>\n              <div class=\"flex gap-3\">\n                <button \n                  onclick=\"openJoinHouseModal()\"\n                  class=\"flex items-center gap-2 bg-[#111] border border-[#222] px-4 py-2 rounded-lg text-sm font-bold hover:bg-[#1a1a1a] transition-all\"\n                >\n                  ${Icons.Plus()} Join House\n                </button>\n                <button \n                  onclick=\"openCreateHouseModal()\"\n                  class=\"flex items-center gap-2 bg-white text-black px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-200 transition-all\"\n                >\n                  ${Icons.Plus()} New House\n                </button>\n              </div>\n            </header>\n\n            <section class=\"space-y-6\">\n              <h2 class=\"text-xs uppercase tracking-[0.2em] text-gray-500 font-bold border-b border-[#222] pb-2\">Active Houses</h2>\n              <div class=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                ${houses.map(house => `\n                  <div onclick=\"viewHouse('${house.id}')\" class=\"block group cursor-pointer\">\n                    <div class=\"bg-[#111] border border-[#222] rounded-2xl overflow-hidden hover:border-gray-500 transition-all duration-300\">\n                      <div class=\"h-24 bg-gradient-to-r from-gray-900 to-black relative\">\n                        <img src=\"${house.emblem}\" alt=\"${house.name}\" class=\"absolute -bottom-6 left-6 w-16 h-16 rounded-xl border-4 border-[#111] shadow-xl group-hover:scale-105 transition-transform\" />\n                      </div>\n                      <div class=\"p-6 pt-10\">\n                        <h3 class=\"text-xl font-bold mb-1\">${house.name}</h3>\n                        <p class=\"text-sm text-gray-500 mb-4 line-clamp-2\">${house.description}</p>\n                        <div class=\"flex items-center justify-between text-xs text-gray-600 font-bold uppercase tracking-wider\">\n                          <span>${house.membersCount} Members</span>\n                          <span class=\"${house.isPrivate ? 'text-red-900' : 'text-blue-900'}\">\n                            ${house.isPrivate ? 'Private' : 'Public'}\n                          </span>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                `).join('')}\n              </div>\n            </section>\n\n            <section class=\"space-y-6\">\n              <h2 class=\"text-xs uppercase tracking-[0.2em] text-gray-500 font-bold border-b border-[#222] pb-2\">Recent Transmission</h2>\n              <div class=\"space-y-4\">\n                ${[1, 2, 3].map(i => `\n                  <div class=\"flex gap-4 p-4 bg-[#0a0a0a] border border-[#1a1a1a] rounded-xl hover:bg-[#0f0f0f] transition-all cursor-pointer\">\n                    <div class=\"w-10 h-10 rounded-full bg-gray-800 flex-shrink-0\"></div>\n                    <div class=\"space-y-1\">\n                      <div class=\"flex items-center gap-2\">\n                        <span class=\"font-bold text-sm\">GhostAgent</span>\n                        <span class=\"text-[10px] text-gray-600 uppercase font-bold\">In Iron Vanguard ‚Ä¢ 2h ago</span>\n                      </div>\n                      <p class=\"text-sm text-gray-400\">The latest security protocols have been uploaded to the vault. Please review your access keys before the next cycle starts...</p>\n                    </div>\n                  </div>\n                `).join('')}\n              </div>\n            </section>\n          </div>\n        </main>\n      </div>\n    `;\n  },\n  \n  houseDetail: () => {\n    const house = AppState.selectedHouse;\n    if (!house) return '<div class=\"p-10 text-white\">House not found</div>';\n    \n    const messages = AppState.houseMessages[house.id] || [];\n    const user = AppState.currentUser;\n    const isOwner = house.ownerId === user.id;\n    \n    return `\n      <div class=\"flex flex-col h-screen max-h-screen bg-[#050505]\">\n        <div class=\"p-4 border-b border-[#222] bg-[#0a0a0a] flex items-center justify-between\">\n          <div class=\"flex items-center gap-3\">\n            <button onclick=\"navigateTo('dashboard')\" class=\"p-2 hover:bg-[#222] rounded-lg transition-all\">\n              ${Icons.Back()}\n            </button>\n            <img src=\"${house.emblem}\" class=\"w-8 h-8 rounded-lg\" alt=\"\" />\n            <div>\n              <h2 class=\"font-bold text-sm uppercase tracking-wider text-white\">${house.name}</h2>\n              <p class=\"text-[10px] text-gray-500 uppercase font-bold\">${house.membersCount} Operatives</p>\n            </div>\n          </div>\n          ${isOwner ? `\n          <div class=\"flex gap-2\">\n            <button onclick=\"openHouseSettings('${house.id}')\" class=\"flex items-center gap-1 p-2 hover:bg-[#222] rounded-lg text-gray-400 hover:text-white transition-all text-xs font-bold uppercase tracking-widest\">\n              ${Icons.Settings()}\n              <span class=\"hidden md:inline\">Manage</span>\n            </button>\n          </div>\n          ` : ''}\n        </div>\n\n        <div id=\"house-messages\" class=\"flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth\">\n          <div class=\"text-center py-10 space-y-4\">\n            <img src=\"${house.emblem}\" class=\"w-24 h-24 mx-auto rounded-3xl border border-[#333]\" alt=\"\" />\n            <div>\n              <h1 class=\"text-2xl font-bold text-white\">${house.name}</h1>\n              <p class=\"text-gray-500 max-w-sm mx-auto\">${house.description}</p>\n            </div>\n            <div class=\"h-[1px] bg-[#222] w-full\"></div>\n          </div>\n\n          ${messages.map(msg => `\n            <div class=\"flex gap-3 group ${msg.senderId === user.id ? 'flex-row-reverse' : ''}\">\n              <img src=\"${msg.senderAvatar}\" class=\"w-8 h-8 rounded-full border border-[#333]\" alt=\"\" />\n              <div class=\"space-y-1 max-w-[80%] ${msg.senderId === user.id ? 'items-end' : 'items-start'}\">\n                <div class=\"flex items-center gap-2\">\n                  <span class=\"text-xs font-bold text-gray-400\">${msg.senderName}</span>\n                  <span class=\"text-[10px] text-gray-600\">${formatTime(msg.timestamp)}</span>\n                </div>\n                <div class=\"px-4 py-2 rounded-2xl text-sm ${msg.senderId === user.id ? 'bg-red-900/20 text-red-100 rounded-tr-none' : 'bg-[#1a1a1a] text-gray-200 rounded-tl-none'}\">\n                  ${msg.content}\n                </div>\n              </div>\n            </div>\n          `).join('')}\n        </div>\n\n        <div class=\"p-4 bg-[#0a0a0a] border-t border-[#222]\">\n          <form onsubmit=\"sendHouseMessage(event, '${house.id}')\" class=\"flex items-center gap-3 bg-black border border-[#333] rounded-2xl px-4 py-1\">\n            <input\n              type=\"text\"\n              id=\"house-message-input\"\n              class=\"flex-1 bg-transparent border-none focus:outline-none text-sm py-3 text-white\"\n              placeholder=\"Secure transmission...\"\n            />\n            <button type=\"submit\" class=\"text-white disabled:opacity-50\">\n              ${Icons.Send()}\n            </button>\n          </form>\n        </div>\n      </div>\n    `;\n  },\n  \n  chat: () => {\n    if (AppState.selectedFriend) {\n      return renderChatWithFriend();\n    }\n    \n    const friends = AppState.friends;\n    const user = AppState.currentUser;\n    \n    return `\n      <div class=\"flex h-screen overflow-hidden bg-[#050505]\">\n        ${renderSidebar()}\n        <main class=\"flex-1 overflow-y-auto pb-16 md:pb-0\">\n          <div class=\"p-6 md:p-12 max-w-4xl mx-auto space-y-12\">\n            <header class=\"flex flex-col md:flex-row md:items-center justify-between gap-6\">\n              <div>\n                <h1 class=\"text-4xl font-extrabold tracking-tight\">Direct Comms</h1>\n                <p class=\"text-gray-500\">Secure one-to-one encrypted transmissions.</p>\n              </div>\n              <button \n                onclick=\"openAddRivalModal()\"\n                class=\"bg-red-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-800 transition-all shadow-lg\"\n              >\n                Add Rival\n              </button>\n            </header>\n\n            <!-- Identity Card -->\n            <div class=\"bg-[#111] border border-[#222] p-6 rounded-3xl flex items-center justify-between group hover:border-gray-700 transition-all\">\n              <div class=\"space-y-1\">\n                <h4 class=\"text-[10px] uppercase font-bold text-gray-500 tracking-widest\">Your Transmission ID</h4>\n                <p class=\"text-2xl font-mono font-bold tracking-tighter text-white\">${user.commsCode}</p>\n              </div>\n              <button \n                onclick=\"copyCommsCode()\"\n                class=\"bg-white/5 hover:bg-white/10 p-3 rounded-xl transition-all\"\n                title=\"Copy Code\"\n              >\n                ${Icons.Copy()}\n              </button>\n            </div>\n\n            <div class=\"space-y-4\">\n              ${friends.length === 0 ? `\n                <div class=\"text-center p-12 bg-[#080808] border border-[#111] rounded-3xl space-y-4\">\n                  <div class=\"text-4xl opacity-20\">üì°</div>\n                  <p class=\"text-gray-600 font-bold uppercase tracking-widest text-xs\">No active rivals detected in this sector.</p>\n                </div>\n              ` : friends.map(friend => `\n                <div \n                  onclick=\"selectFriend('${friend.id}')\"\n                  class=\"flex items-center gap-4 p-4 bg-[#111] border border-[#222] rounded-2xl hover:border-gray-500 transition-all cursor-pointer group\"\n                >\n                  <div class=\"relative\">\n                    <img src=\"${friend.avatar}\" class=\"w-12 h-12 rounded-full bg-gray-800 border border-[#333]\" alt=\"\" />\n                    <div class=\"absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-[#111]\"></div>\n                  </div>\n                  <div class=\"flex-1\">\n                    <div class=\"flex justify-between items-center\">\n                      <span class=\"font-bold text-white group-hover:text-red-400 transition-colors\">${friend.username}</span>\n                      <span class=\"text-[10px] text-gray-600 font-bold uppercase tracking-tighter\">${friend.commsCode}</span>\n                    </div>\n                    <p class=\"text-sm text-gray-500 line-clamp-1 italic\">${friend.lastMessage || 'Secure link established.'}</p>\n                  </div>\n                </div>\n              `).join('')}\n            </div>\n\n            <div class=\"mt-12 text-center p-8 border-2 border-dashed border-[#222] rounded-3xl\">\n              <div class=\"text-3xl mb-4\">ü§ê</div>\n              <h3 class=\"text-lg font-bold mb-1 uppercase tracking-tight\">Zero-Knowledge Comms</h3>\n              <p class=\"text-gray-500 text-sm max-w-xs mx-auto\">RAVEN uses end-to-end encryption. Only the intended recipient can decrypt your transmissions.</p>\n            </div>\n          </div>\n        </main>\n      </div>\n    `;\n  },\n  \n  profile: () => {\n    const user = AppState.currentUser;\n    return `\n      <div class=\"flex h-screen overflow-hidden bg-[#050505]\">\n        ${renderSidebar()}\n        <main class=\"flex-1 overflow-y-auto pb-16 md:pb-0\">\n          <div class=\"p-6 md:p-12 max-w-3xl mx-auto space-y-12\">\n            <header class=\"flex flex-col md:flex-row items-center gap-8 text-center md:text-left\">\n              <div class=\"w-32 h-32 rounded-3xl bg-gradient-to-br from-red-800 to-black p-1 shadow-2xl\">\n                <img src=\"${user.avatar}\" class=\"w-full h-full rounded-[1.4rem] object-cover\" alt=\"\" />\n              </div>\n              <div class=\"space-y-3\">\n                <h1 class=\"text-4xl font-extrabold\">${user.username}</h1>\n                <p class=\"text-gray-400 italic\">\"${user.bio}\"</p>\n                <div class=\"flex flex-wrap justify-center md:justify-start gap-4 text-[10px] uppercase font-bold tracking-widest text-gray-600\">\n                  <span class=\"bg-[#111] border border-[#222] px-3 py-1 rounded-full\">Member Since ${new Date(user.joinedAt).toLocaleDateString()}</span>\n                  <span class=\"bg-[#111] border border-[#222] px-3 py-1 rounded-full\">Level: Operative</span>\n                </div>\n              </div>\n            </header>\n\n            <section class=\"space-y-6\">\n              <h2 class=\"text-xs uppercase tracking-[0.2em] text-gray-500 font-bold border-b border-[#222] pb-2\">Account Intelligence</h2>\n              <div class=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                ${[\n                  { label: \"Notification Protocol\", value: \"Real-time\" },\n                  { label: \"Data Leak Protection\", value: \"Active\" },\n                  { label: \"Encryption Grade\", value: \"Military (AES-256)\" },\n                  { label: \"Linked Comms\", value: \"Disconnected\" }\n                ].map(item => `\n                  <div class=\"bg-[#111] border border-[#222] p-4 rounded-xl flex justify-between items-center\">\n                    <span class=\"text-sm text-gray-500 font-medium\">${item.label}</span>\n                    <span class=\"text-sm text-white font-bold\">${item.value}</span>\n                  </div>\n                `).join('')}\n              </div>\n            </section>\n\n            <footer class=\"pt-12 flex gap-4\">\n              <button class=\"flex-1 bg-[#111] border border-[#222] text-white py-3 rounded-xl font-bold hover:bg-[#1a1a1a] transition-all\">\n                Edit Profile\n              </button>\n              <button onclick=\"handleLogout()\" class=\"flex-1 bg-red-900/20 text-red-500 border border-red-900/30 py-3 rounded-xl font-bold hover:bg-red-900/40 transition-all\">\n                Terminate Session\n              </button>\n            </footer>\n          </div>\n        </main>\n      </div>\n    `;\n  },\n  \n  moderation: () => {\n    return `\n      <div class=\"flex h-screen overflow-hidden bg-[#050505]\">\n        ${renderSidebar()}\n        <main class=\"flex-1 overflow-y-auto pb-16 md:pb-0\">\n          <div class=\"p-6 md:p-12 max-w-6xl mx-auto space-y-12\">\n            <header>\n              <h1 class=\"text-4xl font-extrabold tracking-tight\">Moderation Hub</h1>\n              <p class=\"text-gray-500\">AI-powered content safety and community management.</p>\n            </header>\n\n            <section class=\"space-y-6\">\n              <h2 class=\"text-xs uppercase tracking-[0.2em] text-gray-500 font-bold border-b border-[#222] pb-2\">Recent Flags</h2>\n              <div class=\"text-center p-12 bg-[#080808] border border-[#111] rounded-3xl space-y-4\">\n                <div class=\"text-4xl opacity-20\">‚úÖ</div>\n                <p class=\"text-gray-600 font-bold uppercase tracking-widest text-xs\">All Clear. No violations detected.</p>\n              </div>\n            </section>\n\n            <section class=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n              ${[\n                { label: \"Messages Scanned\", value: \"1,247\", color: \"text-blue-500\" },\n                { label: \"Violations Detected\", value: \"0\", color: \"text-green-500\" },\n                { label: \"Auto-Actions\", value: \"3\", color: \"text-yellow-500\" }\n              ].map(stat => `\n                <div class=\"bg-[#111] border border-[#222] p-6 rounded-xl text-center\">\n                  <div class=\"text-3xl font-black ${stat.color} mb-2\">${stat.value}</div>\n                  <div class=\"text-sm text-gray-500 uppercase tracking-wider font-bold\">${stat.label}</div>\n                </div>\n              `).join('')}\n            </section>\n          </div>\n        </main>\n      </div>\n    `;\n  }\n};\n\nfunction renderSidebar() {\n  const user = AppState.currentUser;\n  if (!user) return '';\n  \n  const isActive = (view) => AppState.currentView === view;\n  \n  return `\n    <div class=\"fixed bottom-0 left-0 right-0 bg-[#0a0a0a] border-t border-[#222] flex justify-around items-center py-3 md:relative md:w-20 md:h-screen md:flex-col md:border-t-0 md:border-r md:pt-8 md:pb-8 z-50\">\n      <button onclick=\"navigateTo('dashboard')\" class=\"p-2 rounded-xl transition-all ${isActive('dashboard') ? 'bg-red-900/20 text-red-500' : 'text-gray-500 hover:text-white'}\">\n        ${Icons.House()}\n      </button>\n      <button onclick=\"navigateTo('chat')\" class=\"p-2 rounded-xl transition-all ${isActive('chat') ? 'bg-blue-900/20 text-blue-500' : 'text-gray-500 hover:text-white'}\">\n        ${Icons.Message()}\n      </button>\n      <button onclick=\"navigateTo('moderation')\" class=\"p-2 rounded-xl transition-all ${isActive('moderation') ? 'bg-gray-800 text-white' : 'text-gray-500 hover:text-white'}\">\n        ${Icons.Shield()}\n      </button>\n      <button onclick=\"navigateTo('profile')\" class=\"p-2 rounded-xl transition-all ${isActive('profile') ? 'bg-gray-800 text-white' : 'text-gray-500 hover:text-white'}\">\n        ${Icons.Profile()}\n      </button>\n    </div>\n  `;\n}\n\nfunction renderChatWithFriend() {\n  const friend = AppState.selectedFriend;\n  const user = AppState.currentUser;\n  const messages = AppState.dmMessages[friend.id] || [];\n  \n  return `\n    <div class=\"flex flex-col h-screen bg-[#050505]\">\n      <header class=\"p-4 border-b border-[#222] bg-[#0a0a0a] flex items-center gap-4\">\n        <button onclick=\"unselectFriend()\" class=\"p-2 hover:bg-[#222] rounded-lg\">\n          ${Icons.Back()}\n        </button>\n        <img src=\"${friend.avatar}\" class=\"w-8 h-8 rounded-full border border-[#333]\" alt=\"\" />\n        <div>\n          <h2 class=\"font-bold text-sm tracking-widest uppercase text-white\">${friend.username}</h2>\n          <p class=\"text-[10px] text-green-500 font-bold uppercase\">Encrypted Connection Active</p>\n        </div>\n      </header>\n\n      <div id=\"dm-messages\" class=\"flex-1 overflow-y-auto p-6 space-y-4\">\n        <div class=\"text-center py-10 opacity-50 space-y-2\">\n          <p class=\"text-[10px] uppercase font-bold tracking-[0.3em] text-gray-500\">End-to-End Encrypted Session</p>\n          <p class=\"text-xs text-gray-600\">Established ${new Date().toLocaleDateString()}</p>\n        </div>\n\n        ${messages.map(msg => `\n          <div class=\"flex gap-3 ${msg.senderId === user.id ? 'flex-row-reverse' : ''}\">\n            <div class=\"px-4 py-2 rounded-2xl text-sm ${msg.senderId === user.id ? 'bg-red-900/20 text-red-100 rounded-tr-none' : 'bg-[#1a1a1a] text-gray-200 rounded-tl-none'}\">\n              ${msg.content}\n            </div>\n          </div>\n        `).join('')}\n      </div>\n\n      <form onsubmit=\"sendDM(event, '${friend.id}')\" class=\"p-4 bg-[#0a0a0a] border-t border-[#222]\">\n        <div class=\"flex items-center gap-3 bg-black border border-[#333] rounded-2xl px-4 py-1\">\n          <input\n            type=\"text\"\n            id=\"dm-input\"\n            class=\"flex-1 bg-transparent border-none focus:outline-none text-sm py-3 text-white\"\n            placeholder=\"Type secure transmission...\"\n          />\n          <button type=\"submit\" class=\"text-white disabled:opacity-30\">\n            ${Icons.Send()}\n          </button>\n        </div>\n      </form>\n    </div>\n  `;\n}\n\n// ============ MODAL RENDERING ============\nconst Modals = {\n  createHouse: () => `\n    <div class=\"fixed inset-0 z-[100] flex items-center justify-center p-4 modal-backdrop\">\n      <div class=\"bg-[#111] border border-[#222] w-full max-w-md rounded-3xl p-8 space-y-6 shadow-2xl\">\n        <h2 class=\"text-2xl font-bold text-white\">Initialize New House</h2>\n        <form onsubmit=\"createHouse(event)\" class=\"space-y-4\">\n          <div class=\"space-y-2\">\n            <label class=\"text-[10px] uppercase font-bold text-gray-500 tracking-widest ml-1\">House Name</label>\n            <input \n              required\n              id=\"house-name\"\n              class=\"w-full bg-black border border-[#333] rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-red-900 outline-none transition-all\"\n              placeholder=\"e.g. Order of the Phoenix\"\n            />\n          </div>\n          <div class=\"space-y-2\">\n            <label class=\"text-[10px] uppercase font-bold text-gray-500 tracking-widest ml-1\">Purpose/Description</label>\n            <textarea \n              id=\"house-desc\"\n              class=\"w-full bg-black border border-[#333] rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-red-900 outline-none transition-all min-h-[100px]\"\n              placeholder=\"What is the mission of this collective?\"\n            ></textarea>\n          </div>\n          <div class=\"flex gap-3 pt-4\">\n            <button type=\"button\" onclick=\"closeModal()\" class=\"flex-1 px-4 py-3 rounded-xl border border-[#222] font-bold text-gray-400 hover:bg-[#1a1a1a]\">Cancel</button>\n            <button type=\"submit\" class=\"flex-1 px-4 py-3 rounded-xl bg-white text-black font-bold hover:bg-gray-200\">Create</button>\n          </div>\n        </form>\n      </div>\n    </div>\n  `,\n  \n  joinHouse: () => {\n    const publicHouses = [\n      { id: 'p1', name: 'Cyber Runners', desc: 'Fast. Anonymous. Global.', emblem: 'https://picsum.photos/seed/cyber/200' },\n      { id: 'p2', name: 'The Mint', desc: 'Secure asset management group.', emblem: 'https://picsum.photos/seed/mint/200' },\n    ];\n    \n    return `\n      <div class=\"fixed inset-0 z-[100] flex items-center justify-center p-4 modal-backdrop\">\n        <div class=\"bg-[#111] border border-[#222] w-full max-w-md rounded-3xl p-8 space-y-6 shadow-2xl\">\n          <h2 class=\"text-2xl font-bold text-white\">Intercept Transmissions</h2>\n          <div class=\"space-y-3\">\n            ${publicHouses.map(ph => `\n              <div \n                onclick=\"joinHouse('${ph.id}', '${ph.name}', '${ph.desc}', '${ph.emblem}')\"\n                class=\"p-4 bg-black border border-[#222] rounded-2xl flex items-center justify-between hover:border-blue-900/50 transition-all cursor-pointer group\"\n              >\n                <div class=\"flex items-center gap-3\">\n                  <img src=\"${ph.emblem}\" class=\"w-10 h-10 rounded-lg\" alt=\"\" />\n                  <div>\n                    <h4 class=\"font-bold text-sm text-white\">${ph.name}</h4>\n                    <p class=\"text-[10px] text-gray-500 uppercase font-bold\">${ph.desc}</p>\n                  </div>\n                </div>\n                <span class=\"text-xs font-bold text-blue-500 group-hover:underline\">Join</span>\n              </div>\n            `).join('')}\n          </div>\n          <button onclick=\"closeModal()\" class=\"w-full py-3 rounded-xl border border-[#222] font-bold text-gray-400 hover:bg-[#1a1a1a]\">Close</button>\n        </div>\n      </div>\n    `;\n  },\n  \n  addRival: () => {\n    return `\n      <div class=\"fixed inset-0 z-[100] flex items-center justify-center p-4 modal-backdrop\">\n        <div class=\"bg-[#111] border border-[#222] w-full max-w-md rounded-3xl p-8 space-y-6 shadow-2xl\">\n          <h2 class=\"text-2xl font-bold text-white\">Initialize Direct Comm</h2>\n          <form onsubmit=\"addRival(event)\" class=\"space-y-4\">\n            <div class=\"space-y-2\">\n              <label class=\"text-[10px] uppercase font-bold text-gray-500 tracking-widest ml-1\">Rival Identity (Name)</label>\n              <input \n                required\n                id=\"rival-name\"\n                class=\"w-full bg-black border border-[#333] rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-red-900 outline-none transition-all\"\n                placeholder=\"e.g. Oracle_X\"\n              />\n            </div>\n            <div class=\"space-y-2\">\n              <label class=\"text-[10px] uppercase font-bold text-gray-500 tracking-widest ml-1\">Transmission Code</label>\n              <input \n                required\n                id=\"rival-code\"\n                class=\"w-full bg-black border border-[#333] rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-red-900 outline-none transition-all\"\n                placeholder=\"RAVEN-XXXX\"\n              />\n            </div>\n            <div id=\"rival-error\" class=\"text-red-500 text-xs font-bold px-1 hidden\"></div>\n            <div class=\"flex gap-3 pt-4\">\n              <button type=\"button\" onclick=\"closeModal()\" class=\"flex-1 px-4 py-3 rounded-xl border border-[#222] font-bold text-gray-400 hover:bg-[#1a1a1a]\">Abort</button>\n              <button type=\"submit\" class=\"flex-1 px-4 py-3 rounded-xl bg-red-900 text-white font-bold hover:bg-red-800\">Add Rival</button>\n            </div>\n          </form>\n        </div>\n      </div>\n    `;\n  }\n};\n\n// ============ NAVIGATION ============\nfunction navigateTo(view) {\n  // Handle authentication protection\n  const protectedViews = ['dashboard', 'chat', 'profile', 'moderation', 'houseDetail'];\n  \n  if (protectedViews.includes(view) && !AppState.currentUser) {\n    view = 'landing';\n  }\n  \n  if (view === 'landing' && AppState.currentUser) {\n    view = 'dashboard';\n  }\n  \n  AppState.currentView = view;\n  render();\n}\n\nfunction viewHouse(houseId) {\n  const house = AppState.houses.find(h => h.id === houseId);\n  if (house) {\n    AppState.selectedHouse = house;\n    AppState.currentView = 'houseDetail';\n    render();\n    // Scroll to bottom after render\n    setTimeout(() => {\n      const messagesDiv = document.getElementById('house-messages');\n      if (messagesDiv) {\n        messagesDiv.scrollTop = messagesDiv.scrollHeight;\n      }\n    }, 100);\n  }\n}\n\nfunction selectFriend(friendId) {\n  const friend = AppState.friends.find(f => f.id === friendId);\n  if (friend) {\n    AppState.selectedFriend = friend;\n    render();\n    // Scroll to bottom after render\n    setTimeout(() => {\n      const messagesDiv = document.getElementById('dm-messages');\n      if (messagesDiv) {\n        messagesDiv.scrollTop = messagesDiv.scrollHeight;\n      }\n    }, 100);\n  }\n}\n\nfunction unselectFriend() {\n  AppState.selectedFriend = null;\n  render();\n}\n\n// ============ AUTHENTICATION ============\nfunction handleLogin() {\n  const newUser = {\n    id: 'me',\n    username: 'RavenOperative',\n    avatar: 'https://picsum.photos/seed/raven/200',\n    bio: 'Shadow architect. Privacy enthusiast.',\n    joinedAt: Date.now(),\n    commsCode: 'RAVEN-' + Math.floor(1000 + Math.random() * 9000),\n  };\n  \n  AppState.currentUser = newUser;\n  AppState.saveUser();\n  navigateTo('dashboard');\n}\n\nfunction handleLogout() {\n  if (confirm('Are you sure you want to terminate your session?')) {\n    AppState.logout();\n    AppState.selectedFriend = null;\n    AppState.selectedHouse = null;\n    navigateTo('landing');\n  }\n}\n\n// ============ MODALS ============\nfunction openCreateHouseModal() {\n  document.getElementById('modals').innerHTML = Modals.createHouse();\n}\n\nfunction openJoinHouseModal() {\n  document.getElementById('modals').innerHTML = Modals.joinHouse();\n}\n\nfunction openAddRivalModal() {\n  document.getElementById('modals').innerHTML = Modals.addRival();\n}\n\nfunction closeModal() {\n  document.getElementById('modals').innerHTML = '';\n}\n\nfunction openHouseSettings(houseId) {\n  alert('House settings coming soon!');\n}\n\n// ============ HOUSE ACTIONS ============\nfunction createHouse(event) {\n  event.preventDefault();\n  \n  const name = document.getElementById('house-name').value;\n  const desc = document.getElementById('house-desc').value;\n  \n  const newHouse = {\n    id: 'h-' + Date.now(),\n    name,\n    description: desc,\n    emblem: `https://picsum.photos/seed/${name}/200`,\n    ownerId: AppState.currentUser.id,\n    membersCount: 1,\n    isPrivate: true,\n    members: [{\n      id: AppState.currentUser.id,\n      username: AppState.currentUser.username,\n      avatar: AppState.currentUser.avatar,\n      roleId: 'r1',\n      joinedAt: Date.now()\n    }]\n  };\n  \n  AppState.houses.push(newHouse);\n  AppState.saveHouses();\n  closeModal();\n  viewHouse(newHouse.id);\n}\n\nfunction joinHouse(id, name, desc, emblem) {\n  const newHouse = {\n    id,\n    name,\n    description: desc,\n    emblem,\n    ownerId: 'npc',\n    membersCount: 42,\n    isPrivate: false,\n    members: [{\n      id: AppState.currentUser.id,\n      username: AppState.currentUser.username,\n      avatar: AppState.currentUser.avatar,\n      roleId: 'r4',\n      joinedAt: Date.now()\n    }]\n  };\n  \n  AppState.houses.push(newHouse);\n  AppState.saveHouses();\n  closeModal();\n  navigateTo('dashboard');\n}\n\n// ============ MESSAGING ============\nfunction sendHouseMessage(event, houseId) {\n  event.preventDefault();\n  \n  const input = document.getElementById('house-message-input');\n  const content = input.value.trim();\n  \n  if (!content) return;\n  \n  const newMessage = {\n    id: 'msg-' + Date.now(),\n    senderId: AppState.currentUser.id,\n    senderName: AppState.currentUser.username,\n    senderAvatar: AppState.currentUser.avatar,\n    content: content,\n    timestamp: Date.now(),\n  };\n  \n  if (!AppState.houseMessages[houseId]) {\n    AppState.houseMessages[houseId] = [];\n  }\n  \n  AppState.houseMessages[houseId].push(newMessage);\n  AppState.saveHouseMessages();\n  \n  input.value = '';\n  render();\n  \n  // Scroll to bottom\n  setTimeout(() => {\n    const messagesDiv = document.getElementById('house-messages');\n    if (messagesDiv) {\n      messagesDiv.scrollTop = messagesDiv.scrollHeight;\n    }\n  }, 100);\n}\n\nfunction sendDM(event, friendId) {\n  event.preventDefault();\n  \n  const input = document.getElementById('dm-input');\n  const content = input.value.trim();\n  \n  if (!content) return;\n  \n  const newMessage = {\n    id: 'dm-' + Date.now(),\n    senderId: AppState.currentUser.id,\n    senderName: AppState.currentUser.username,\n    senderAvatar: AppState.currentUser.avatar,\n    content: content,\n    timestamp: Date.now(),\n    recipientId: friendId,\n  };\n  \n  if (!AppState.dmMessages[friendId]) {\n    AppState.dmMessages[friendId] = [];\n  }\n  \n  AppState.dmMessages[friendId].push(newMessage);\n  AppState.saveDms();\n  \n  input.value = '';\n  render();\n  \n  // Scroll to bottom\n  setTimeout(() => {\n    const messagesDiv = document.getElementById('dm-messages');\n    if (messagesDiv) {\n      messagesDiv.scrollTop = messagesDiv.scrollHeight;\n    }\n  }, 100);\n}\n\n// ============ FRIEND ACTIONS ============\nfunction addRival(event) {\n  event.preventDefault();\n  \n  const name = document.getElementById('rival-name').value;\n  const code = document.getElementById('rival-code').value;\n  const errorDiv = document.getElementById('rival-error');\n  \n  if (code.trim() === AppState.currentUser.commsCode) {\n    errorDiv.textContent = 'Cannot add yourself as a rival.';\n    errorDiv.classList.remove('hidden');\n    return;\n  }\n  \n  const newFriend = {\n    id: 'u-' + Date.now(),\n    username: name,\n    avatar: `https://picsum.photos/seed/${code}/200`,\n    commsCode: code,\n    lastMessage: 'Secure link established.'\n  };\n  \n  AppState.friends.push(newFriend);\n  AppState.saveFriends();\n  closeModal();\n  selectFriend(newFriend.id);\n}\n\nfunction copyCommsCode() {\n  const code = AppState.currentUser.commsCode;\n  navigator.clipboard.writeText(code).then(() => {\n    alert('Comms Code copied to secure clipboard.');\n  }).catch(() => {\n    // Fallback for older browsers\n    const textArea = document.createElement('textarea');\n    textArea.value = code;\n    document.body.appendChild(textArea);\n    textArea.select();\n    document.execCommand('copy');\n    document.body.removeChild(textArea);\n    alert('Comms Code copied to secure clipboard.');\n  });\n}\n\n// ============ UTILITIES ============\nfunction formatTime(timestamp) {\n  const date = new Date(timestamp);\n  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n}\n\n// ============ MAIN RENDER ============\nfunction render() {\n  const app = document.getElementById('app');\n  const viewRenderer = Views[AppState.currentView];\n  \n  if (viewRenderer) {\n    app.innerHTML = viewRenderer();\n  } else {\n    app.innerHTML = '<div class=\"text-white p-10\">View not found</div>';\n  }\n}\n\n// ============ INITIALIZATION ============\nwindow.addEventListener('DOMContentLoaded', () => {\n  AppState.init();\n  \n  // Determine initial view\n  if (AppState.currentUser) {\n    AppState.currentView = 'dashboard';\n  } else {\n    AppState.currentView = 'landing';\n  }\n  \n  render();\n});\n